<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title id="title">Marching Squares</title>
<script src="https://cdn.rawgit.com/toji/gl-matrix/v3.3.0/dist/gl-matrix.js"></script>
<script src="https://legacygl-js.glitch.me/gl-matrix-util.js"></script>
<script src="https://legacygl-js.glitch.me/legacygl.js"></script>
<script src="https://legacygl-js.glitch.me/drawutil.js"></script>
<script src="https://legacygl-js.glitch.me/camera.js"></script>
<script src="https://legacygl-js.glitch.me/util.js"></script>
<script src="https://legacygl-js.glitch.me/glu.js"></script>
<script type="text/javascript">
var gl;
var canvas;
var legacygl;
var drawutil;
var camera;
const minpoint = [-2.5, -1.5];
const maxpoint = [2.5, 1.5];
const resolution = [150, 90];
const width = vec2.divide_ip(vec2.sub([], maxpoint, minpoint), resolution);

// function f(p) {
//     var x = p[0] / 2.0;
//     var y = p[1] / 1.0;
//     return x * x + y * y - 1.0;
// }

function f(p) {
    var x = p[0] / 1.5;
    var y = p[1];
    x = x >= 0 ? x : -x;
    y = y >= 0 ? y : -y;
    return x ** (2 / 3) + y ** (2 / 3) - 1.2;
}

function Pixel(centre) {
    this.centre = centre;
    this.upperleft   = [centre[0] - 0.5 * width[0], centre[1] + 0.5 * width[1]];
    this.uppercentre = [centre[0]                 , centre[1] + 0.5 * width[1]];
    this.upperright  = [centre[0] + 0.5 * width[0], centre[1] + 0.5 * width[1]];
    this.centreright = [centre[0] + 0.5 * width[0], centre[1]                 ];
    this.lowerright  = [centre[0] + 0.5 * width[0], centre[1] - 0.5 * width[1]];
    this.lowercentre = [centre[0]                 , centre[1] - 0.5 * width[1]];
    this.lowerleft   = [centre[0] - 0.5 * width[0], centre[1] - 0.5 * width[1]];
    this.centreleft  = [centre[0] - 0.5 * width[0], centre[1]                 ];
}
function lookuptable(v, centreleft, centreright, uppercentre, lowercentre) {
    if (v == 1 || v == 14) {
        return [[centreleft, lowercentre]];
    } else if (v == 2 || v == 13) {
        return [[centreright, lowercentre]];
    } else if (v == 3 || v == 12) {
        return [[centreleft, centreright]];
    } else if (v == 4 || v == 11) {
        return [[centreright, uppercentre]];
    } else if (v == 5) {
        return [[centreleft, lowercentre], [centreright, uppercentre]];
    } else if (v == 6 || v == 9) {
        return [[uppercentre, lowercentre]];
    } else if (v == 7 || v == 8) {
        return [[centreleft, uppercentre]];
    } else if (v == 10) {
        return [[centreleft, uppercentre], [centreright, lowercentre]];
    } else {
        return [];
    }
}
function dr(centre) {
    var pixel = new Pixel(centre);
    legacygl.color(0.6, 1.0, 0.2);
    legacygl.begin(gl.LINE_STRIP);
    var index =   Number(f(pixel.upperleft) < 0) << 3 
                | Number(f(pixel.upperright) < 0) << 2 
                | Number(f(pixel.lowerright) < 0) << 1 
                | Number(f(pixel.lowerleft) < 0);
    lookuptable(index, centreleft, centreright, uppercentre, lowercentre).forEach(function(e){
        e.forEach(function(v){
            legacygl.vertex2(v);
        });
    });
    legacygl.end();
}

function draw() {
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    // projection & camera position
    mat4.perspective(legacygl.uniforms.projection.value, Math.PI / 6, canvas.aspect_ratio(), 0.1, 1000);
    var modelview = legacygl.uniforms.modelview;
    camera.lookAt(modelview.value);
    
    // xy grid
    gl.lineWidth(1);
    legacygl.color(0.5, 0.5, 0.5);
    drawutil.xygrid(100);
    
    // draw
    for (var i = 0; i < resolution_x; i++) {
        for (var j = 0; j < resolution_y; j++) {        
            var x = width * (i + 0.5) + xmin;
            var y = height * (j + 0.5) + ymin;
            dr([x, y]);
        }
    }
}
  
function init() {
    // OpenGL context
    canvas = document.getElementById("canvas");
    gl = canvas.getContext("experimental-webgl");
    if (!gl)
        alert("Could not initialise WebGL, sorry :-(");
    var vertex_shader_src = "\
        attribute vec3 a_vertex;\
        attribute vec3 a_color;\
        varying vec3 v_color;\
        uniform mat4 u_modelview;\
        uniform mat4 u_projection;\
        void main(void) {\
            gl_Position = u_projection * u_modelview * vec4(a_vertex, 1.0);\
            v_color = a_color;\
            gl_PointSize = 5.0;\
        }\
        ";
    var fragment_shader_src = "\
        precision mediump float;\
        varying vec3 v_color;\
        void main(void) {\
            gl_FragColor = vec4(v_color, 1.0);\
        }\
        ";
    legacygl = get_legacygl(gl, vertex_shader_src, fragment_shader_src);
    legacygl.add_uniform("modelview", "Matrix4f");
    legacygl.add_uniform("projection", "Matrix4f");
    legacygl.add_vertex_attribute("color", 3);
    legacygl.vertex2 = function(p) {
        this.vertex(p[0], p[1], 0);
    };
    drawutil = get_drawutil(gl, legacygl);
    camera = get_camera(canvas.width);
    camera.eye = [0, 0, 7];
    // points = [];
    // points.push([-0.5, -0.6]);
    // points.push([1.2, 0.5]);
    // points.push([-0.4, 1.3]);
    // event handlers
    canvas.onmousedown = function(evt) {
        var mouse_win = this.get_mousepos(evt);
        camera.start_moving(mouse_win, evt.shiftKey ? "zoom" : "pan");
        return;
    };
    canvas.onmousemove = function(evt) {
        var mouse_win = this.get_mousepos(evt);
        if (camera.is_moving()) {
            camera.move(mouse_win);
            draw();
            return;
        }
    }
    document.onmouseup = function (evt) {
        if (camera.is_moving()) {
            camera.finish_moving();
            return;
        }
    };
    // init OpenGL settings
    gl.viewport(0, 0, canvas.width, canvas.height);
    gl.clearColor(1, 1, 1, 1);
};
</script>
</head>
<body onload="init(); draw();">
  <h2><script type="text/javascript">document.write(document.getElementById("title").innerHTML);</script></h2>
  <canvas id="canvas" width="640" height="480" style="border:1px solid #000000"></canvas>
  <h3>Usage:</h3>
  <ul>
    <li>Drag: Camera Pan</li>
    <li>Shift+drag: Camera Zoom</li>
  </ul>

  <div class="glitchButton" style="position:fixed;top:20px;right:20px;"></div>
  <script src="https://button.glitch.me/button.js"></script>
</body>
</html>
