<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title id="title">Marching Cubes, Marching Tetrahedra</title>
<script src="https://cdn.rawgit.com/toji/gl-matrix/v3.3.0/dist/gl-matrix.js"></script>
<script src="https://legacygl-js.glitch.me/gl-matrix-util.js"></script>
<script src="https://legacygl-js.glitch.me/legacygl.js"></script>
<script src="https://legacygl-js.glitch.me/drawutil.js"></script>
<script src="https://legacygl-js.glitch.me/camera.js"></script>
<script src="https://legacygl-js.glitch.me/util.js"></script>
<script src="https://legacygl-js.glitch.me/glu.js"></script>
<script type="text/javascript">
var gl;
var canvas;
var legacygl;
var drawutil;
var camera;

// minpointからmaxpointまでの空間を解像度resolutionで分割
const minpoint = [-5.0, -5.0, -5.0];
const maxpoint = [5.0, 5.0, 5.0];
var resolution = new Array(3);    // 格子点の個数
var width = new Array(3);    // 格子点間の幅

// 図形一覧
var figure;
function Figure(kind, f1, f2) {
    // if kind == 0, 関数f1に対して図形f1(p)<0
    // if kind == 1, 関数f1に対して図形f1(p)>=0
    // if kind == 2, 図形f1,f2に対してf1とf2の和集合
    // if kind == 3, 図形f1,f2に対してf1とf2の積集合
    // if kind == 4, 図形f1,f2に対してf1とf2の差集合
    this.kind = kind;
    this.f1 = f1;
    this.f2 = f2;
}
const sphere = new Figure(0, function(p){ return vec3.sqrLen(p) - 20.0 });
const torus = new Figure(0, function(p){ const R = 3.5, a = 1.0; const x = p[0], y = p[1], z = p[2]; return (x * x + y * y + z * z + R * R - a * a) ** 2 - 4.0 * R * R * (x * x + z * z) });
const cone = new Figure(0, function(p){ const x = p[0], y = p[1], z = p[2]; return x * x + z * z - 0.15 * (y - 5.0) * (y - 5.0) });
const wineglass = new Figure(0, function(p){ const x = p[0], y = p[1], z = p[2]; return x * x + z * z - Math.log(y + 5.1) ** 2 - 0.02 });
const three_toruses = new Figure(2,
    new Figure(2,
        new Figure(0, function(p){ const R = 4.0, a = 0.5; const x = p[0], y = p[1], z = p[2]; return (x * x + y * y + z * z + R * R - a * a) ** 2 - 4.0 * R * R * (x * x + y * y) }),
        new Figure(0, function(p){ const R = 4.0, a = 0.5; const x = p[0], y = p[1], z = p[2]; return (x * x + y * y + z * z + R * R - a * a) ** 2 - 4.0 * R * R * (y * y + z * z) })),
    new Figure(0, function(p){ const R = 4.0, a = 0.5; const x = p[0], y = p[1], z = p[2]; return (x * x + y * y + z * z + R * R - a * a) ** 2 - 4.0 * R * R * (z * z + x * x) }));
const cone_and_wineglass = new Figure(3, cone, wineglass);
const sphere_minus_3toruses = new Figure(4, sphere, three_toruses);
const far_metaballs = new Figure(1, function(p){ return 1.2 / vec3.dist(p, [-2.5, 0.5, 2.5]) + 1.2 / vec3.dist(p, [2.5, -1.5, -2.5]) - 1.0 });
const close_metaballs = new Figure(1, function(p){ return 1.2 / vec3.dist(p, [-1.5, 0.5, 1.5]) + 1.2 / vec3.dist(p, [1.5, -1.5, -1.5]) - 1.0 });

// Marching Cubes用のlookup table
// https://gist.github.com/ttammear/a3cdc214023f8c92b1f0bf27e7cc08d1 より引用
const triangleTableForCube =
    [
        [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 1, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 8, 3, 9, 8, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 3, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [9, 2, 10, 0, 2, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [2, 8, 3, 2, 10, 8, 10, 9, 8, -1, -1, -1, -1, -1, -1, -1],
        [3, 11, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 11, 2, 8, 11, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 9, 0, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 11, 2, 1, 9, 11, 9, 8, 11, -1, -1, -1, -1, -1, -1, -1],
        [3, 10, 1, 11, 10, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 10, 1, 0, 8, 10, 8, 11, 10, -1, -1, -1, -1, -1, -1, -1],
        [3, 9, 0, 3, 11, 9, 11, 10, 9, -1, -1, -1, -1, -1, -1, -1],
        [9, 8, 10, 10, 8, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 3, 0, 7, 3, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 1, 9, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 1, 9, 4, 7, 1, 7, 3, 1, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 10, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [3, 4, 7, 3, 0, 4, 1, 2, 10, -1, -1, -1, -1, -1, -1, -1],
        [9, 2, 10, 9, 0, 2, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1],
        [2, 10, 9, 2, 9, 7, 2, 7, 3, 7, 9, 4, -1, -1, -1, -1],
        [8, 4, 7, 3, 11, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [11, 4, 7, 11, 2, 4, 2, 0, 4, -1, -1, -1, -1, -1, -1, -1],
        [9, 0, 1, 8, 4, 7, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1],
        [4, 7, 11, 9, 4, 11, 9, 11, 2, 9, 2, 1, -1, -1, -1, -1],
        [3, 10, 1, 3, 11, 10, 7, 8, 4, -1, -1, -1, -1, -1, -1, -1],
        [1, 11, 10, 1, 4, 11, 1, 0, 4, 7, 11, 4, -1, -1, -1, -1],
        [4, 7, 8, 9, 0, 11, 9, 11, 10, 11, 0, 3, -1, -1, -1, -1],
        [4, 7, 11, 4, 11, 9, 9, 11, 10, -1, -1, -1, -1, -1, -1, -1],
        [9, 5, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [9, 5, 4, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 5, 4, 1, 5, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [8, 5, 4, 8, 3, 5, 3, 1, 5, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 10, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [3, 0, 8, 1, 2, 10, 4, 9, 5, -1, -1, -1, -1, -1, -1, -1],
        [5, 2, 10, 5, 4, 2, 4, 0, 2, -1, -1, -1, -1, -1, -1, -1],
        [2, 10, 5, 3, 2, 5, 3, 5, 4, 3, 4, 8, -1, -1, -1, -1],
        [9, 5, 4, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 11, 2, 0, 8, 11, 4, 9, 5, -1, -1, -1, -1, -1, -1, -1],
        [0, 5, 4, 0, 1, 5, 2, 3, 11, -1, -1, -1, -1, -1, -1, -1],
        [2, 1, 5, 2, 5, 8, 2, 8, 11, 4, 8, 5, -1, -1, -1, -1],
        [10, 3, 11, 10, 1, 3, 9, 5, 4, -1, -1, -1, -1, -1, -1, -1],
        [4, 9, 5, 0, 8, 1, 8, 10, 1, 8, 11, 10, -1, -1, -1, -1],
        [5, 4, 0, 5, 0, 11, 5, 11, 10, 11, 0, 3, -1, -1, -1, -1],
        [5, 4, 8, 5, 8, 10, 10, 8, 11, -1, -1, -1, -1, -1, -1, -1],
        [9, 7, 8, 5, 7, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [9, 3, 0, 9, 5, 3, 5, 7, 3, -1, -1, -1, -1, -1, -1, -1],
        [0, 7, 8, 0, 1, 7, 1, 5, 7, -1, -1, -1, -1, -1, -1, -1],
        [1, 5, 3, 3, 5, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [9, 7, 8, 9, 5, 7, 10, 1, 2, -1, -1, -1, -1, -1, -1, -1],
        [10, 1, 2, 9, 5, 0, 5, 3, 0, 5, 7, 3, -1, -1, -1, -1],
        [8, 0, 2, 8, 2, 5, 8, 5, 7, 10, 5, 2, -1, -1, -1, -1],
        [2, 10, 5, 2, 5, 3, 3, 5, 7, -1, -1, -1, -1, -1, -1, -1],
        [7, 9, 5, 7, 8, 9, 3, 11, 2, -1, -1, -1, -1, -1, -1, -1],
        [9, 5, 7, 9, 7, 2, 9, 2, 0, 2, 7, 11, -1, -1, -1, -1],
        [2, 3, 11, 0, 1, 8, 1, 7, 8, 1, 5, 7, -1, -1, -1, -1],
        [11, 2, 1, 11, 1, 7, 7, 1, 5, -1, -1, -1, -1, -1, -1, -1],
        [9, 5, 8, 8, 5, 7, 10, 1, 3, 10, 3, 11, -1, -1, -1, -1],
        [5, 7, 0, 5, 0, 9, 7, 11, 0, 1, 0, 10, 11, 10, 0, -1],
        [11, 10, 0, 11, 0, 3, 10, 5, 0, 8, 0, 7, 5, 7, 0, -1],
        [11, 10, 5, 7, 11, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [10, 6, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 3, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [9, 0, 1, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 8, 3, 1, 9, 8, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1],
        [1, 6, 5, 2, 6, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 6, 5, 1, 2, 6, 3, 0, 8, -1, -1, -1, -1, -1, -1, -1],
        [9, 6, 5, 9, 0, 6, 0, 2, 6, -1, -1, -1, -1, -1, -1, -1],
        [5, 9, 8, 5, 8, 2, 5, 2, 6, 3, 2, 8, -1, -1, -1, -1],
        [2, 3, 11, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [11, 0, 8, 11, 2, 0, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1],
        [0, 1, 9, 2, 3, 11, 5, 10, 6, -1, -1, -1, -1, -1, -1, -1],
        [5, 10, 6, 1, 9, 2, 9, 11, 2, 9, 8, 11, -1, -1, -1, -1],
        [6, 3, 11, 6, 5, 3, 5, 1, 3, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 11, 0, 11, 5, 0, 5, 1, 5, 11, 6, -1, -1, -1, -1],
        [3, 11, 6, 0, 3, 6, 0, 6, 5, 0, 5, 9, -1, -1, -1, -1],
        [6, 5, 9, 6, 9, 11, 11, 9, 8, -1, -1, -1, -1, -1, -1, -1],
        [5, 10, 6, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 3, 0, 4, 7, 3, 6, 5, 10, -1, -1, -1, -1, -1, -1, -1],
        [1, 9, 0, 5, 10, 6, 8, 4, 7, -1, -1, -1, -1, -1, -1, -1],
        [10, 6, 5, 1, 9, 7, 1, 7, 3, 7, 9, 4, -1, -1, -1, -1],
        [6, 1, 2, 6, 5, 1, 4, 7, 8, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 5, 5, 2, 6, 3, 0, 4, 3, 4, 7, -1, -1, -1, -1],
        [8, 4, 7, 9, 0, 5, 0, 6, 5, 0, 2, 6, -1, -1, -1, -1],
        [7, 3, 9, 7, 9, 4, 3, 2, 9, 5, 9, 6, 2, 6, 9, -1],
        [3, 11, 2, 7, 8, 4, 10, 6, 5, -1, -1, -1, -1, -1, -1, -1],
        [5, 10, 6, 4, 7, 2, 4, 2, 0, 2, 7, 11, -1, -1, -1, -1],
        [0, 1, 9, 4, 7, 8, 2, 3, 11, 5, 10, 6, -1, -1, -1, -1],
        [9, 2, 1, 9, 11, 2, 9, 4, 11, 7, 11, 4, 5, 10, 6, -1],
        [8, 4, 7, 3, 11, 5, 3, 5, 1, 5, 11, 6, -1, -1, -1, -1],
        [5, 1, 11, 5, 11, 6, 1, 0, 11, 7, 11, 4, 0, 4, 11, -1],
        [0, 5, 9, 0, 6, 5, 0, 3, 6, 11, 6, 3, 8, 4, 7, -1],
        [6, 5, 9, 6, 9, 11, 4, 7, 9, 7, 11, 9, -1, -1, -1, -1],
        [10, 4, 9, 6, 4, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 10, 6, 4, 9, 10, 0, 8, 3, -1, -1, -1, -1, -1, -1, -1],
        [10, 0, 1, 10, 6, 0, 6, 4, 0, -1, -1, -1, -1, -1, -1, -1],
        [8, 3, 1, 8, 1, 6, 8, 6, 4, 6, 1, 10, -1, -1, -1, -1],
        [1, 4, 9, 1, 2, 4, 2, 6, 4, -1, -1, -1, -1, -1, -1, -1],
        [3, 0, 8, 1, 2, 9, 2, 4, 9, 2, 6, 4, -1, -1, -1, -1],
        [0, 2, 4, 4, 2, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [8, 3, 2, 8, 2, 4, 4, 2, 6, -1, -1, -1, -1, -1, -1, -1],
        [10, 4, 9, 10, 6, 4, 11, 2, 3, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 2, 2, 8, 11, 4, 9, 10, 4, 10, 6, -1, -1, -1, -1],
        [3, 11, 2, 0, 1, 6, 0, 6, 4, 6, 1, 10, -1, -1, -1, -1],
        [6, 4, 1, 6, 1, 10, 4, 8, 1, 2, 1, 11, 8, 11, 1, -1],
        [9, 6, 4, 9, 3, 6, 9, 1, 3, 11, 6, 3, -1, -1, -1, -1],
        [8, 11, 1, 8, 1, 0, 11, 6, 1, 9, 1, 4, 6, 4, 1, -1],
        [3, 11, 6, 3, 6, 0, 0, 6, 4, -1, -1, -1, -1, -1, -1, -1],
        [6, 4, 8, 11, 6, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [7, 10, 6, 7, 8, 10, 8, 9, 10, -1, -1, -1, -1, -1, -1, -1],
        [0, 7, 3, 0, 10, 7, 0, 9, 10, 6, 7, 10, -1, -1, -1, -1],
        [10, 6, 7, 1, 10, 7, 1, 7, 8, 1, 8, 0, -1, -1, -1, -1],
        [10, 6, 7, 10, 7, 1, 1, 7, 3, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 6, 1, 6, 8, 1, 8, 9, 8, 6, 7, -1, -1, -1, -1],
        [2, 6, 9, 2, 9, 1, 6, 7, 9, 0, 9, 3, 7, 3, 9, -1],
        [7, 8, 0, 7, 0, 6, 6, 0, 2, -1, -1, -1, -1, -1, -1, -1],
        [7, 3, 2, 6, 7, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [2, 3, 11, 10, 6, 8, 10, 8, 9, 8, 6, 7, -1, -1, -1, -1],
        [2, 0, 7, 2, 7, 11, 0, 9, 7, 6, 7, 10, 9, 10, 7, -1],
        [1, 8, 0, 1, 7, 8, 1, 10, 7, 6, 7, 10, 2, 3, 11, -1],
        [11, 2, 1, 11, 1, 7, 10, 6, 1, 6, 7, 1, -1, -1, -1, -1],
        [8, 9, 6, 8, 6, 7, 9, 1, 6, 11, 6, 3, 1, 3, 6, -1],
        [0, 9, 1, 11, 6, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [7, 8, 0, 7, 0, 6, 3, 11, 0, 11, 6, 0, -1, -1, -1, -1],
        [7, 11, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [7, 6, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [3, 0, 8, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 1, 9, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [8, 1, 9, 8, 3, 1, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1],
        [10, 1, 2, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 10, 3, 0, 8, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1],
        [2, 9, 0, 2, 10, 9, 6, 11, 7, -1, -1, -1, -1, -1, -1, -1],
        [6, 11, 7, 2, 10, 3, 10, 8, 3, 10, 9, 8, -1, -1, -1, -1],
        [7, 2, 3, 6, 2, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [7, 0, 8, 7, 6, 0, 6, 2, 0, -1, -1, -1, -1, -1, -1, -1],
        [2, 7, 6, 2, 3, 7, 0, 1, 9, -1, -1, -1, -1, -1, -1, -1],
        [1, 6, 2, 1, 8, 6, 1, 9, 8, 8, 7, 6, -1, -1, -1, -1],
        [10, 7, 6, 10, 1, 7, 1, 3, 7, -1, -1, -1, -1, -1, -1, -1],
        [10, 7, 6, 1, 7, 10, 1, 8, 7, 1, 0, 8, -1, -1, -1, -1],
        [0, 3, 7, 0, 7, 10, 0, 10, 9, 6, 10, 7, -1, -1, -1, -1],
        [7, 6, 10, 7, 10, 8, 8, 10, 9, -1, -1, -1, -1, -1, -1, -1],
        [6, 8, 4, 11, 8, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [3, 6, 11, 3, 0, 6, 0, 4, 6, -1, -1, -1, -1, -1, -1, -1],
        [8, 6, 11, 8, 4, 6, 9, 0, 1, -1, -1, -1, -1, -1, -1, -1],
        [9, 4, 6, 9, 6, 3, 9, 3, 1, 11, 3, 6, -1, -1, -1, -1],
        [6, 8, 4, 6, 11, 8, 2, 10, 1, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 10, 3, 0, 11, 0, 6, 11, 0, 4, 6, -1, -1, -1, -1],
        [4, 11, 8, 4, 6, 11, 0, 2, 9, 2, 10, 9, -1, -1, -1, -1],
        [10, 9, 3, 10, 3, 2, 9, 4, 3, 11, 3, 6, 4, 6, 3, -1],
        [8, 2, 3, 8, 4, 2, 4, 6, 2, -1, -1, -1, -1, -1, -1, -1],
        [0, 4, 2, 4, 6, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 9, 0, 2, 3, 4, 2, 4, 6, 4, 3, 8, -1, -1, -1, -1],
        [1, 9, 4, 1, 4, 2, 2, 4, 6, -1, -1, -1, -1, -1, -1, -1],
        [8, 1, 3, 8, 6, 1, 8, 4, 6, 6, 10, 1, -1, -1, -1, -1],
        [10, 1, 0, 10, 0, 6, 6, 0, 4, -1, -1, -1, -1, -1, -1, -1],
        [4, 6, 3, 4, 3, 8, 6, 10, 3, 0, 3, 9, 10, 9, 3, -1],
        [10, 9, 4, 6, 10, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 9, 5, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 3, 4, 9, 5, 11, 7, 6, -1, -1, -1, -1, -1, -1, -1],
        [5, 0, 1, 5, 4, 0, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1],
        [11, 7, 6, 8, 3, 4, 3, 5, 4, 3, 1, 5, -1, -1, -1, -1],
        [9, 5, 4, 10, 1, 2, 7, 6, 11, -1, -1, -1, -1, -1, -1, -1],
        [6, 11, 7, 1, 2, 10, 0, 8, 3, 4, 9, 5, -1, -1, -1, -1],
        [7, 6, 11, 5, 4, 10, 4, 2, 10, 4, 0, 2, -1, -1, -1, -1],
        [3, 4, 8, 3, 5, 4, 3, 2, 5, 10, 5, 2, 11, 7, 6, -1],
        [7, 2, 3, 7, 6, 2, 5, 4, 9, -1, -1, -1, -1, -1, -1, -1],
        [9, 5, 4, 0, 8, 6, 0, 6, 2, 6, 8, 7, -1, -1, -1, -1],
        [3, 6, 2, 3, 7, 6, 1, 5, 0, 5, 4, 0, -1, -1, -1, -1],
        [6, 2, 8, 6, 8, 7, 2, 1, 8, 4, 8, 5, 1, 5, 8, -1],
        [9, 5, 4, 10, 1, 6, 1, 7, 6, 1, 3, 7, -1, -1, -1, -1],
        [1, 6, 10, 1, 7, 6, 1, 0, 7, 8, 7, 0, 9, 5, 4, -1],
        [4, 0, 10, 4, 10, 5, 0, 3, 10, 6, 10, 7, 3, 7, 10, -1],
        [7, 6, 10, 7, 10, 8, 5, 4, 10, 4, 8, 10, -1, -1, -1, -1],
        [6, 9, 5, 6, 11, 9, 11, 8, 9, -1, -1, -1, -1, -1, -1, -1],
        [3, 6, 11, 0, 6, 3, 0, 5, 6, 0, 9, 5, -1, -1, -1, -1],
        [0, 11, 8, 0, 5, 11, 0, 1, 5, 5, 6, 11, -1, -1, -1, -1],
        [6, 11, 3, 6, 3, 5, 5, 3, 1, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 10, 9, 5, 11, 9, 11, 8, 11, 5, 6, -1, -1, -1, -1],
        [0, 11, 3, 0, 6, 11, 0, 9, 6, 5, 6, 9, 1, 2, 10, -1],
        [11, 8, 5, 11, 5, 6, 8, 0, 5, 10, 5, 2, 0, 2, 5, -1],
        [6, 11, 3, 6, 3, 5, 2, 10, 3, 10, 5, 3, -1, -1, -1, -1],
        [5, 8, 9, 5, 2, 8, 5, 6, 2, 3, 8, 2, -1, -1, -1, -1],
        [9, 5, 6, 9, 6, 0, 0, 6, 2, -1, -1, -1, -1, -1, -1, -1],
        [1, 5, 8, 1, 8, 0, 5, 6, 8, 3, 8, 2, 6, 2, 8, -1],
        [1, 5, 6, 2, 1, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 3, 6, 1, 6, 10, 3, 8, 6, 5, 6, 9, 8, 9, 6, -1],
        [10, 1, 0, 10, 0, 6, 9, 5, 0, 5, 6, 0, -1, -1, -1, -1],
        [0, 3, 8, 5, 6, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [10, 5, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [11, 5, 10, 7, 5, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [11, 5, 10, 11, 7, 5, 8, 3, 0, -1, -1, -1, -1, -1, -1, -1],
        [5, 11, 7, 5, 10, 11, 1, 9, 0, -1, -1, -1, -1, -1, -1, -1],
        [10, 7, 5, 10, 11, 7, 9, 8, 1, 8, 3, 1, -1, -1, -1, -1],
        [11, 1, 2, 11, 7, 1, 7, 5, 1, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 3, 1, 2, 7, 1, 7, 5, 7, 2, 11, -1, -1, -1, -1],
        [9, 7, 5, 9, 2, 7, 9, 0, 2, 2, 11, 7, -1, -1, -1, -1],
        [7, 5, 2, 7, 2, 11, 5, 9, 2, 3, 2, 8, 9, 8, 2, -1],
        [2, 5, 10, 2, 3, 5, 3, 7, 5, -1, -1, -1, -1, -1, -1, -1],
        [8, 2, 0, 8, 5, 2, 8, 7, 5, 10, 2, 5, -1, -1, -1, -1],
        [9, 0, 1, 5, 10, 3, 5, 3, 7, 3, 10, 2, -1, -1, -1, -1],
        [9, 8, 2, 9, 2, 1, 8, 7, 2, 10, 2, 5, 7, 5, 2, -1],
        [1, 3, 5, 3, 7, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 7, 0, 7, 1, 1, 7, 5, -1, -1, -1, -1, -1, -1, -1],
        [9, 0, 3, 9, 3, 5, 5, 3, 7, -1, -1, -1, -1, -1, -1, -1],
        [9, 8, 7, 5, 9, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [5, 8, 4, 5, 10, 8, 10, 11, 8, -1, -1, -1, -1, -1, -1, -1],
        [5, 0, 4, 5, 11, 0, 5, 10, 11, 11, 3, 0, -1, -1, -1, -1],
        [0, 1, 9, 8, 4, 10, 8, 10, 11, 10, 4, 5, -1, -1, -1, -1],
        [10, 11, 4, 10, 4, 5, 11, 3, 4, 9, 4, 1, 3, 1, 4, -1],
        [2, 5, 1, 2, 8, 5, 2, 11, 8, 4, 5, 8, -1, -1, -1, -1],
        [0, 4, 11, 0, 11, 3, 4, 5, 11, 2, 11, 1, 5, 1, 11, -1],
        [0, 2, 5, 0, 5, 9, 2, 11, 5, 4, 5, 8, 11, 8, 5, -1],
        [9, 4, 5, 2, 11, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [2, 5, 10, 3, 5, 2, 3, 4, 5, 3, 8, 4, -1, -1, -1, -1],
        [5, 10, 2, 5, 2, 4, 4, 2, 0, -1, -1, -1, -1, -1, -1, -1],
        [3, 10, 2, 3, 5, 10, 3, 8, 5, 4, 5, 8, 0, 1, 9, -1],
        [5, 10, 2, 5, 2, 4, 1, 9, 2, 9, 4, 2, -1, -1, -1, -1],
        [8, 4, 5, 8, 5, 3, 3, 5, 1, -1, -1, -1, -1, -1, -1, -1],
        [0, 4, 5, 1, 0, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [8, 4, 5, 8, 5, 3, 9, 0, 5, 0, 3, 5, -1, -1, -1, -1],
        [9, 4, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 11, 7, 4, 9, 11, 9, 10, 11, -1, -1, -1, -1, -1, -1, -1],
        [0, 8, 3, 4, 9, 7, 9, 11, 7, 9, 10, 11, -1, -1, -1, -1],
        [1, 10, 11, 1, 11, 4, 1, 4, 0, 7, 4, 11, -1, -1, -1, -1],
        [3, 1, 4, 3, 4, 8, 1, 10, 4, 7, 4, 11, 10, 11, 4, -1],
        [4, 11, 7, 9, 11, 4, 9, 2, 11, 9, 1, 2, -1, -1, -1, -1],
        [9, 7, 4, 9, 11, 7, 9, 1, 11, 2, 11, 1, 0, 8, 3, -1],
        [11, 7, 4, 11, 4, 2, 2, 4, 0, -1, -1, -1, -1, -1, -1, -1],
        [11, 7, 4, 11, 4, 2, 8, 3, 4, 3, 2, 4, -1, -1, -1, -1],
        [2, 9, 10, 2, 7, 9, 2, 3, 7, 7, 4, 9, -1, -1, -1, -1],
        [9, 10, 7, 9, 7, 4, 10, 2, 7, 8, 7, 0, 2, 0, 7, -1],
        [3, 7, 10, 3, 10, 2, 7, 4, 10, 1, 10, 0, 4, 0, 10, -1],
        [1, 10, 2, 8, 7, 4, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 9, 1, 4, 1, 7, 7, 1, 3, -1, -1, -1, -1, -1, -1, -1],
        [4, 9, 1, 4, 1, 7, 0, 8, 1, 8, 7, 1, -1, -1, -1, -1],
        [4, 0, 3, 7, 4, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [4, 8, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [9, 10, 8, 10, 11, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [3, 0, 9, 3, 9, 11, 11, 9, 10, -1, -1, -1, -1, -1, -1, -1],
        [0, 1, 10, 0, 10, 8, 8, 10, 11, -1, -1, -1, -1, -1, -1, -1],
        [3, 1, 10, 11, 3, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 2, 11, 1, 11, 9, 9, 11, 8, -1, -1, -1, -1, -1, -1, -1],
        [3, 0, 9, 3, 9, 11, 1, 2, 9, 2, 11, 9, -1, -1, -1, -1],
        [0, 2, 11, 8, 0, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [3, 2, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [2, 3, 8, 2, 8, 10, 10, 8, 9, -1, -1, -1, -1, -1, -1, -1],
        [9, 10, 2, 0, 9, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [2, 3, 8, 2, 8, 10, 0, 1, 8, 1, 10, 8, -1, -1, -1, -1],
        [1, 10, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [1, 3, 8, 9, 1, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 9, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [0, 3, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1],
        [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1]
    ];

// 点pointでの、図形figureを表す陰関数の値を計算
function calc_value(point, figure) {    
    if (figure.kind == 0) {
        return figure.f1(point);
    } else if (figure.kind == 1) {
        return -figure.f1(point);
    } else if (figure.kind == 2) {    // A or B のときは、minを取る
        return Math.min(calc_value(point, figure.f1), calc_value(point, figure.f2));
    } else if (figure.kind == 3) {    // A and B のときは、maxを取る
        return Math.max(calc_value(point, figure.f1), calc_value(point, figure.f2));
    } else if (figure.kind == 4) {    // A - B = A and (not B)
        return Math.max(calc_value(point, figure.f1), -calc_value(point, figure.f2));
    }
}

// 2点point1,point2を線形補間した点の座標
function interpolation(point1, point2, value1, value2) {    
    if (value1 == value2) {
        return vec3.scale_ip(vec3.add([], point1, point2), 0.5);
    } else {
        return vec3.scale_ip(vec3.sub([], vec3.scale([], point2, value1), vec3.scale([], point1, value2)), 1.0 / (value1 - value2));
    }
}

function draw() {
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    // projection & camera position
    mat4.perspective(legacygl.uniforms.projection.value, Math.PI / 6, canvas.aspect_ratio(), 0.1, 1000);
    var modelview = legacygl.uniforms.modelview;
    camera.lookAt(modelview.value);
    // zx grid
    legacygl.color(0.5, 0.5, 0.5);
    drawutil.zxgrid(50);
    // draw meshes
    resolution = [Number(document.getElementById("input_resolution_x").value), 
                  Number(document.getElementById("input_resolution_y").value),
                  Number(document.getElementById("input_resolution_z").value)]
    width = vec3.divide_ip(vec3.sub([], maxpoint, minpoint), resolution);
    figure = 
        document.getElementById("input_sphere").checked ? sphere :
        document.getElementById("input_torus").checked ? torus : 
        document.getElementById("input_cone").checked ? cone : 
        document.getElementById("input_wineglass").checked ? wineglass :
        document.getElementById("input_three_toruses").checked ? three_toruses :
        document.getElementById("input_cone_and_wineglass").checked ? cone_and_wineglass :
        document.getElementById("input_sphere_minus_3toruses").checked ? sphere_minus_3toruses :
        document.getElementById("input_far_metaballs").checked ? far_metaballs : 
        document.getElementById("input_close_metaballs").checked ? close_metaballs : 
        undefined;
    const points = new Array(resolution[0] + 1);    // 各格子点の座標
    for (var i = 0; i <= resolution[0]; i++) {
        points[i] = new Array(resolution[1] + 1);
        for (var j = 0; j <= resolution[1]; j++) {
            points[i][j] = new Array(resolution[2] + 1);
            for (var k = 0; k <= resolution[2]; k++) {
                points[i][j][k] = vec3.add([], minpoint, vec3.mul([], [i, j, k], width));
            }
        }
    }
    const values = new Array(resolution[0] + 1);    // 各格子点の関数値
    for (var i = 0; i <= resolution[0]; i++) {
        values[i] = new Array(resolution[1] + 1);
        for (var j = 0; j <= resolution[1]; j++) {
            values[i][j] = new Array(resolution[2] + 1);
            for (var k = 0; k <= resolution[2]; k++) {
                values[i][j][k] = calc_value(points[i][j][k], figure);
            }
        }
    }
    for (var i = 0; i < resolution[0]; i++) {
        for (var j = 0; j < resolution[1]; j++) {
            for (var k = 0; k < resolution[2]; k++) {
                const cube_points =    // 直方体セルの各頂点の座標
                    [points[i  ][j][k], points[i  ][j][k+1], points[i  ][j+1][k+1], points[i  ][j+1][k],
                     points[i+1][j][k], points[i+1][j][k+1], points[i+1][j+1][k+1], points[i+1][j+1][k]];
                const cube_values =    // 直方体セルの各頂点の関数値
                    [values[i  ][j][k], values[i  ][j][k+1], values[i  ][j+1][k+1], values[i  ][j+1][k],
                     values[i+1][j][k], values[i+1][j][k+1], values[i+1][j+1][k+1], values[i+1][j+1][k]];
                if (document.getElementById("input_marching_cubes").checked) {    // Marching Cubes
                    // https://www.youtube.com/watch?v=B_xk71YopsA を参考にした
                    // http://paulbourke.net/geometry/polygonise/ を参考にした
                    // 直方体セルの各頂点の関数値の正負パターン（関数値が負 iff. 図形の内部）から、生成するメッシュのタイプを決定
                    var index = 0;
                    for (var m = 0; m < 8; m++) {
                        index |= (cube_values[m] < 0 ? 1 : 0) << m;
                    }
                    const triangleIndexList = triangleTableForCube[index];    // 三角形メッシュの頂点がそれ上にある（図形の境界と交わる）ような「直方体セルの辺」の番号のリスト
                    // 関数値の線形補間から、生成するメッシュの頂点の座標を決定
                    const trianglePointList = new Array();    // 三角形メッシュの頂点の座標のリスト
                    for (var m = 0; ; m++) {
                        if (triangleIndexList[m] < 0) {
                            break;
                        } else if (triangleIndexList[m] == 0) {
                            trianglePointList.push(interpolation(cube_points[0], cube_points[1], cube_values[0], cube_values[1]));
                        } else if (triangleIndexList[m] == 1) {
                            trianglePointList.push(interpolation(cube_points[1], cube_points[2], cube_values[1], cube_values[2]));
                        } else if (triangleIndexList[m] == 2) {
                            trianglePointList.push(interpolation(cube_points[2], cube_points[3], cube_values[2], cube_values[3]));
                        } else if (triangleIndexList[m] == 3) {
                            trianglePointList.push(interpolation(cube_points[3], cube_points[0], cube_values[3], cube_values[0]));
                        } else if (triangleIndexList[m] == 4) {
                            trianglePointList.push(interpolation(cube_points[4], cube_points[5], cube_values[4], cube_values[5]));
                        } else if (triangleIndexList[m] == 5) {
                            trianglePointList.push(interpolation(cube_points[5], cube_points[6], cube_values[5], cube_values[6]));
                        } else if (triangleIndexList[m] == 6) {
                            trianglePointList.push(interpolation(cube_points[6], cube_points[7], cube_values[6], cube_values[7]));
                        } else if (triangleIndexList[m] == 7) {
                            trianglePointList.push(interpolation(cube_points[7], cube_points[4], cube_values[7], cube_values[4]));
                        } else if (triangleIndexList[m] == 8) {
                            trianglePointList.push(interpolation(cube_points[0], cube_points[4], cube_values[0], cube_values[4]));
                        } else if (triangleIndexList[m] == 9) {
                            trianglePointList.push(interpolation(cube_points[1], cube_points[5], cube_values[1], cube_values[5]));
                        } else if (triangleIndexList[m] == 10) {
                            trianglePointList.push(interpolation(cube_points[2], cube_points[6], cube_values[2], cube_values[6]));
                        } else if (triangleIndexList[m] == 11) {
                            trianglePointList.push(interpolation(cube_points[3], cube_points[7], cube_values[3], cube_values[7]));
                        }
                    }
                    // 三角形メッシュを描画
                    for (var m = 0; m < trianglePointList.length; m += 3) {
                        if (document.getElementById("input_show_surface").checked) {
                            legacygl.color(0.9, 0.9, 0.2);
                            legacygl.begin(gl.TRIANGLES);
                            legacygl.vertex3(trianglePointList[m]);
                            legacygl.vertex3(trianglePointList[m + 1]);
                            legacygl.vertex3(trianglePointList[m + 2]);
                            legacygl.end();
                        }
                        if (document.getElementById("input_show_edges").checked) {
                            legacygl.color(1, 0.6, 0.2);
                            legacygl.begin(gl.LINE_STRIP);
                            legacygl.vertex3(trianglePointList[m]);
                            legacygl.vertex3(trianglePointList[m + 1]);
                            legacygl.vertex3(trianglePointList[m + 2]);
                            legacygl.end();
                        }
                    }
                } else if (document.getElementById("input_marching_tetrahedra").checked) {    // Marching Tetrahedra
                    // http://paulbourke.net/geometry/polygonise/ を参考にした
                    const ls = [[0, 2, 3, 7], [0, 2, 6, 7], [0, 4, 6, 7], [0, 6, 1, 2], [0, 6, 1, 4], [5, 6, 1, 4]];
                    ls.forEach(function(l) {
                        const tetrahedron_points = l.map(m => cube_points[m]);
                        const tetrahedron_values = l.map(m => cube_values[m]);
                        var index = 0;
                        for (var m = 0; m < 4; m++) {
                            index |= (tetrahedron_values[m] < 0 ? 1 : 0) << m;
                        }
                        const trianglePointList = new Array();
                        if (index == 0 || index == 15) {
                            // do nothing
                        } else if (index == 1 || index == 14) {
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[1], tetrahedron_values[0], tetrahedron_values[1]));
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[2], tetrahedron_values[0], tetrahedron_values[2]));
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[3], tetrahedron_values[0], tetrahedron_values[3]));
                        } else if (index == 2 || index == 13) {
                            trianglePointList.push(interpolation(tetrahedron_points[1], tetrahedron_points[2], tetrahedron_values[1], tetrahedron_values[2]));
                            trianglePointList.push(interpolation(tetrahedron_points[1], tetrahedron_points[3], tetrahedron_values[1], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[1], tetrahedron_points[0], tetrahedron_values[1], tetrahedron_values[0]));
                        } else if (index == 4 || index == 11) {
                            trianglePointList.push(interpolation(tetrahedron_points[2], tetrahedron_points[3], tetrahedron_values[2], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[2], tetrahedron_points[0], tetrahedron_values[2], tetrahedron_values[0]));
                            trianglePointList.push(interpolation(tetrahedron_points[2], tetrahedron_points[1], tetrahedron_values[2], tetrahedron_values[1]));
                        } else if (index == 7 || index == 8) {
                            trianglePointList.push(interpolation(tetrahedron_points[3], tetrahedron_points[0], tetrahedron_values[3], tetrahedron_values[0]));
                            trianglePointList.push(interpolation(tetrahedron_points[3], tetrahedron_points[1], tetrahedron_values[3], tetrahedron_values[1]));
                            trianglePointList.push(interpolation(tetrahedron_points[3], tetrahedron_points[2], tetrahedron_values[3], tetrahedron_values[2]));
                        } else if (index == 3 || index == 12) {
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[3], tetrahedron_values[0], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[2], tetrahedron_values[0], tetrahedron_values[2]));
                            trianglePointList.push(interpolation(tetrahedron_points[1], tetrahedron_points[3], tetrahedron_values[1], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[1], tetrahedron_points[3], tetrahedron_values[1], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[1], tetrahedron_points[2], tetrahedron_values[1], tetrahedron_values[2]));
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[2], tetrahedron_values[0], tetrahedron_values[2]));
                        } else if (index == 5 || index == 10) {
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[1], tetrahedron_values[0], tetrahedron_values[1]));
                            trianglePointList.push(interpolation(tetrahedron_points[2], tetrahedron_points[3], tetrahedron_values[2], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[3], tetrahedron_values[0], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[1], tetrahedron_values[0], tetrahedron_values[1]));
                            trianglePointList.push(interpolation(tetrahedron_points[1], tetrahedron_points[2], tetrahedron_values[1], tetrahedron_values[2]));
                            trianglePointList.push(interpolation(tetrahedron_points[2], tetrahedron_points[3], tetrahedron_values[2], tetrahedron_values[3]));
                        } else if (index == 6 || index == 9) {
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[1], tetrahedron_values[0], tetrahedron_values[1]));
                            trianglePointList.push(interpolation(tetrahedron_points[1], tetrahedron_points[3], tetrahedron_values[1], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[2], tetrahedron_points[3], tetrahedron_values[2], tetrahedron_values[3]));
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[1], tetrahedron_values[0], tetrahedron_values[1]));
                            trianglePointList.push(interpolation(tetrahedron_points[0], tetrahedron_points[2], tetrahedron_values[0], tetrahedron_values[2]));
                            trianglePointList.push(interpolation(tetrahedron_points[2], tetrahedron_points[3], tetrahedron_values[2], tetrahedron_values[3]));
                        }
                        // 三角形メッシュを描画
                        for (var m = 0; m < trianglePointList.length; m += 3) {
                            if (document.getElementById("input_show_surface").checked) {
                                legacygl.color(0.9, 0.9, 0.2);
                                legacygl.begin(gl.TRIANGLES);
                                legacygl.vertex3(trianglePointList[m]);
                                legacygl.vertex3(trianglePointList[m + 1]);
                                legacygl.vertex3(trianglePointList[m + 2]);
                                legacygl.end();
                            }
                            if (document.getElementById("input_show_edges").checked) {
                                legacygl.color(1, 0.6, 0.2);
                                legacygl.begin(gl.LINE_STRIP);
                                legacygl.vertex3(trianglePointList[m]);
                                legacygl.vertex3(trianglePointList[m + 1]);
                                legacygl.vertex3(trianglePointList[m + 2]);
                                legacygl.end();
                            }
                        }
                    });
                }
            }
        }
    }
}

function init() {
    // OpenGL context
    canvas = document.getElementById("canvas");
    gl = canvas.getContext("experimental-webgl");
    if (!gl)
        alert("Could not initialise WebGL, sorry :-(");
    var vertex_shader_src = "\
        attribute vec3 a_vertex;\
        attribute vec3 a_color;\
        varying vec3 v_color;\
        uniform mat4 u_modelview;\
        uniform mat4 u_projection;\
        void main(void) {\
            gl_Position = u_projection * u_modelview * vec4(a_vertex, 1.0);\
            v_color = a_color;\
            gl_PointSize = 5.0;\
        }\
        ";
    var fragment_shader_src = "\
        precision mediump float;\
        varying vec3 v_color;\
        void main(void) {\
            gl_FragColor = vec4(v_color, 1.0);\
        }\
        ";
    legacygl = get_legacygl(gl, vertex_shader_src, fragment_shader_src);
    legacygl.add_uniform("modelview", "Matrix4f");
    legacygl.add_uniform("projection", "Matrix4f");
    legacygl.add_vertex_attribute("color", 3);
    legacygl.vertex3 = function(p) {
        this.vertex(p[0], p[1], p[2]);
    };
    drawutil = get_drawutil(gl, legacygl);
    camera = get_camera(canvas.width);
    camera.eye = [15, 12, 20];
    // event handlers
    canvas.onmousedown = function(evt) {
        var mouse_win = this.get_mousepos(evt);
        camera.start_moving(mouse_win, evt.shiftKey ? "zoom" : evt.ctrlKey ? "pan" : "rotate");
    };
    canvas.onmousemove = function(evt) {
        var mouse_win = this.get_mousepos(evt);
        if (camera.is_moving()) {
            camera.move(mouse_win);
            draw();
        }
    };
    document.onmouseup = function (evt) {
        if (camera.is_moving()) {
            camera.finish_moving();
        }
    };
    // init OpenGL settings
    gl.viewport(0, 0, canvas.width, canvas.height);
    gl.enable(gl.DEPTH_TEST);
    gl.clearColor(1, 1, 1, 1);
};
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=MML_SVG"></script>
</head>
<body onload="init(); draw();">
  <h2><script type="text/javascript">document.write(document.getElementById("title").innerHTML);</script></h2>
  <canvas id="canvas" width="640" height="480" style="border:1px solid #000000"></canvas>
  <table>
    <tr>
      <td>Method:</td>
      <td>
        <input type="radio" name="input_method" id="input_marching_cubes" onchange="draw();" checked>Marching Cubes&emsp;
        <input type="radio" name="input_method" id="input_marching_tetrahedra" onchange="draw();">Marching Tetrahedra
      </td>
    </tr>
    <tr>
      <td>Figure:</td>
      <td>
        <input type="radio" name="input_figure" id="input_sphere" onchange="draw();" checked>sphere&ensp;
        <input type="radio" name="input_figure" id="input_torus" onchange="draw();">torus&ensp;
        <input type="radio" name="input_figure" id="input_cone" onchange="draw();">cone&ensp;
        <input type="radio" name="input_figure" id="input_wineglass" onchange="draw();">wineglass<br>
        <input type="radio" name="input_figure" id="input_three_toruses" onchange="draw();">3 toruses&ensp;
        <input type="radio" name="input_figure" id="input_cone_and_wineglass" onchange="draw();">cone <math><mo>&cap;</mo></math> wineglass&ensp;
        <input type="radio" name="input_figure" id="input_sphere_minus_3toruses" onchange="draw();">sphere - 3 toruses<br>
        <input type="radio" name="input_figure" id="input_far_metaballs" onchange="draw();">far metaballs&ensp;
        <input type="radio" name="input_figure" id="input_close_metaballs" onchange="draw();">close metaballs
      </td>
    </tr>
    <tr>
      <td>Resolution:</td>
      <td>
        <input type="number" id="input_resolution_x" onchange="draw();" style="width:50px;" min="1" step="1" value="20"><math><mo>&times;</mo></math>
        <input type="number" id="input_resolution_y" onchange="draw();" style="width:50px;" min="1" step="1" value="20"><math><mo>&times;</mo></math>
        <input type="number" id="input_resolution_z" onchange="draw();" style="width:50px;" min="1" step="1" value="20">
      </td>
    </tr>
    <tr>
      <td>Show Surface:</td>
      <td><input type="checkbox" id="input_show_surface" onchange="draw();" checked></td>
    </tr>
    <tr>
      <td>Show Edges:</td>
      <td><input type="checkbox" id="input_show_edges" onchange="draw();" checked></td>
    </tr>
  </table>
  <h3>Usage:</h3>
  <ul>
    <li>Drag: Camera Rotate</li>
    <li>Shift+drag: Camera Zoom</li>
    <li>Ctrl+drag: Camera Pan</li>
  </ul>
  
  <div class="glitchButton" style="position:fixed;top:20px;right:20px;"></div>
  <script src="https://button.glitch.me/button.js"></script>
</body>
</html>
