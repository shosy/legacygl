<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title id="title">Marching Squares</title>
<script src="https://cdn.rawgit.com/toji/gl-matrix/v3.3.0/dist/gl-matrix.js"></script>
<script src="https://legacygl-js.glitch.me/gl-matrix-util.js"></script>
<script src="https://legacygl-js.glitch.me/legacygl.js"></script>
<script src="https://legacygl-js.glitch.me/drawutil.js"></script>
<script src="https://legacygl-js.glitch.me/camera.js"></script>
<script src="https://legacygl-js.glitch.me/util.js"></script>
<script src="https://legacygl-js.glitch.me/glu.js"></script>
<script type="text/javascript">
var gl;
var canvas;
var legacygl;
var drawutil;
var camera;
// var points;
// var selected = null;

// function f(p) {
//     var x = p[0] / 2.0;
//     var y = p[1] / 1.0;
//     return x * x + y * y - 1.0;
// }

function f(p) {
    var x = p[0] / 1.5;
    var y = p[1];
    x = x >= 0 ? x : -x;
    y = y >= 0 ? y : -y;
    return x ** (2 / 3) + y ** (2 / 3) - 1.2;
}

function lookuptable(v, centreleft, centreright, uppercentre, lowercentre) {
    if (v == 1 || v == 14) {
        return [[centreleft, lowercentre]];
    } else if (v == 2 || v == 13) {
        return [[centreright, lowercentre]];
    } else if (v == 3 || v == 12) {
        return [[centreleft, centreright]];
    } else if (v == 4 || v == 11) {
        return [[centreright, uppercentre]];
    } else if (v == 5) {
        return [[centreleft, lowercentre], [centreright, uppercentre]];
    } else if (v == 6 || v == 9) {
        return [[uppercentre, lowercentre]];
    } else if (v == 7 || v == 8) {
        return [[centreleft, uppercentre]];
    } else if (v == 10) {
        return [[centreleft, uppercentre], [centreright, lowercentre]];
    } else {
        return [];
    }
}
function dr(centre, width, height) {
    var lowerleft = [centre[0] - 0.5 * width, centre[1] - 0.5 * height];
    var lowerright = [centre[0] + 0.5 * width, centre[1] - 0.5 * height];
    var upperleft = [centre[0] - 0.5 * width, centre[1] + 0.5 * height];
    var upperright = [centre[0] + 0.5 * width, centre[1] + 0.5 * height];
    // if (f(lowerleft) < 0 && f(lowerright) < 0 && f(upperleft) < 0 && f(upperright) < 0) {
    //     legacygl.color(0.6, 1.0, 0.2);
    //     legacygl.begin(gl.LINE_STRIP);
    //     legacygl.vertex2(lowerleft);
    //     legacygl.vertex2(lowerright);
    //     legacygl.vertex2(upperright);
    //     legacygl.vertex2(upperleft);
    //     legacygl.vertex2(lowerleft);
    //     legacygl.end();
    //     console.log(centre);
    // }
    var centreleft = [centre[0] - 0.5 * width, centre[1]];
    var centreright = [centre[0] + 0.5 * width, centre[1]];
    var uppercentre = [centre[0], centre[1] + 0.5 * height];
    var lowercentre = [centre[0], centre[1] - 0.5 * height];
    legacygl.color(0.6, 1.0, 0.2);
    legacygl.begin(gl.LINE_STRIP);
    var index = 0;
    if (f(upperleft) < 0) index += 8;
    if (f(upperright) < 0) index += 4;
    if (f(lowerright) < 0) index += 2;
    if (f(lowerleft) < 0) index += 1;
    lookuptable(index, centreleft, centreright, uppercentre, lowercentre).forEach(function(e){
        e.forEach(function(v){
            legacygl.vertex2(v);
        });
    });
    legacygl.end();
}

function draw() {
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    // projection & camera position
    mat4.perspective(legacygl.uniforms.projection.value, Math.PI / 6, canvas.aspect_ratio(), 0.1, 1000);
    var modelview = legacygl.uniforms.modelview;
    camera.lookAt(modelview.value);
    
    // xy grid
    gl.lineWidth(1);
    legacygl.color(0.5, 0.5, 0.5);
    drawutil.xygrid(100);
    
    // draw
    legacygl.color(1, 0.6, 0.2);
    legacygl.begin(gl.LINE_STRIP);
    legacygl.vertex2([0.0, 0.0]);
    legacygl.vertex2([1.5, 1.0]);
    legacygl.vertex2([-2.0, -0.5]);
    legacygl.end();
    
    // draw
    var resolution_x = 200;
    var resolution_y = 120;
    var xmin = -2.5;
    var xmax = 2.5;
    var ymin = -1.5;
    var ymax = 1.5;
    var width = (xmax - xmin) / resolution_x;
    var height = (ymax - ymin) / resolution_y;
    for (var i = 0; i <= resolution_x; i++) {
        for (var j = 0; j <= resolution_y; j++) {        
            var x = (xmax - xmin) * i / resolution_x + xmin;
            var y = (ymax - ymin) * j / resolution_y + ymin;
            dr([x, y], width, height);
        }
    }
}
  
function init() {
    // OpenGL context
    canvas = document.getElementById("canvas");
    gl = canvas.getContext("experimental-webgl");
    if (!gl)
        alert("Could not initialise WebGL, sorry :-(");
    var vertex_shader_src = "\
        attribute vec3 a_vertex;\
        attribute vec3 a_color;\
        varying vec3 v_color;\
        uniform mat4 u_modelview;\
        uniform mat4 u_projection;\
        void main(void) {\
            gl_Position = u_projection * u_modelview * vec4(a_vertex, 1.0);\
            v_color = a_color;\
            gl_PointSize = 5.0;\
        }\
        ";
    var fragment_shader_src = "\
        precision mediump float;\
        varying vec3 v_color;\
        void main(void) {\
            gl_FragColor = vec4(v_color, 1.0);\
        }\
        ";
    legacygl = get_legacygl(gl, vertex_shader_src, fragment_shader_src);
    legacygl.add_uniform("modelview", "Matrix4f");
    legacygl.add_uniform("projection", "Matrix4f");
    legacygl.add_vertex_attribute("color", 3);
    legacygl.vertex2 = function(p) {
        this.vertex(p[0], p[1], 0);
    };
    drawutil = get_drawutil(gl, legacygl);
    camera = get_camera(canvas.width);
    camera.eye = [0, 0, 7];
    // points = [];
    // points.push([-0.5, -0.6]);
    // points.push([1.2, 0.5]);
    // points.push([-0.4, 1.3]);
    // event handlers
    canvas.onmousedown = function(evt) {
        var mouse_win = this.get_mousepos(evt);
        camera.start_moving(mouse_win, evt.shiftKey ? "zoom" : "pan");
        return;
    };
    canvas.onmousemove = function(evt) {
        var mouse_win = this.get_mousepos(evt);
        if (camera.is_moving()) {
            camera.move(mouse_win);
            draw();
            return;
        }
    }
    document.onmouseup = function (evt) {
        if (camera.is_moving()) {
            camera.finish_moving();
            return;
        }
    };
    // init OpenGL settings
    gl.viewport(0, 0, canvas.width, canvas.height);
    gl.clearColor(1, 1, 1, 1);
};
</script>
</head>
<body onload="init(); draw();">
  <h2><script type="text/javascript">document.write(document.getElementById("title").innerHTML);</script></h2>
  <canvas id="canvas" width="640" height="480" style="border:1px solid #000000"></canvas>
  <h3>Usage:</h3>
  <ul>
    <li>Drag: Camera Pan</li>
    <li>Shift+drag: Camera Zoom</li>
  </ul>

  <div class="glitchButton" style="position:fixed;top:20px;right:20px;"></div>
  <script src="https://button.glitch.me/button.js"></script>
</body>
</html>
